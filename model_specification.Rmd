---
title: "Snow Crab population model specification"
author: "Tobie Surette"
date: "12/7/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Data 

Source data for the model came from the annual snow crab survey.

Length-frequencies standardized by trawl swept area were calculated by survey year, sex and morphometric maturity.

For the purposes of evaluating and developing the snow crab model, the time series was limited to the period from  2006 to 2020, owing to the spatial homogeneity of the sampling design during this period. The survey was marginally expanded in 2011 and this will need to be considered when interpreting the model results.

The time series will be extended in future version of the model into past surveys where changing survey area and heterogeneous spatial distributions may lead to some degree of scaling issues, which will hopefully be corrected by the model.

## Model

### Approach

The benthic stages of snow crab instars are traditionally numbered using roman numerals, with immature stages 
being instars I up to VII or VIII, characterized by high relative grow rates, followed by slower growing adolescence at instars VIII and IX for females and VIII to XII for males, and mature stages at instars IX and X for females and IX to XIII for males.

Instars I, II and III are too small to be caught by the survey. 
Instar IV crab are sometimes caught in small amounts.


### Growth-at-moult

Population instars were assumed to follow a Gaussian distribution curve with specified mean and error. Means for successive instars  instar was defined iteratively as follows, allowing for known differences in growth between immature and pubescent (adolescent?):
$$
   \mu_{k+1} = \alpha_{imm}\mu_{k} + \beta_{imm}, \text{ for }  k \le 7  \\
   \mu_{k+1} = \alpha_{ado}\mu_{k} + \beta_{ado}, \text{ for }  k > 7  \\
$$
where $\mu_{k}$ is the mean for the $k^{th}$ instar,  $\alpha_{imm}$ and $\beta_{ado}$ are Hiatt slope and intercept parameters, respectively for immature crab, and $\alpha_{ado}$ and $\beta_{ado}$ are the corresponding parameters for the adolescent maturity phase.

Instar standard errors are similarly defined, but allow for additional error inflation in the form of two positive parameters $\gamma_{imm}$ and $\gamma_{ado}$ to allow for extra error in the growth process:

$$
   \sigma_{k+1} = (\alpha_{imm} + \gamma_{imm}) \sigma_{k}, \text{ for } k \le 7  \text{ and }  \gamma_{imm} > 0 \\
   \sigma_{k+1} = (\alpha_{ado} + \gamma_{ado}) \sigma_{k}, \text{ for } k > 7  \text{ and }  \gamma_{ado} > 0 \\   
$$
For mature crab, we simply include an additive term for 

$$
   \mu_{k}^{mat} = \mu_{k}^{ado} + \Delta_{mat}
$$
where we expect that $\Delta_{mat} < 0$, based on biological considerations.

Inferences on growth-at-moult can often be obtained from analysis of these modes and the approach has traditionally been to treat the data as arising from finite mixture model with probability density of the form:

$$
   \sum_{k=1}^{K} \pi_k \phi \left(x | \mu_k , \sigma_k^2  \right)
$$
where $k$ indexes the instars, $x$ represents crab size, $\pi_k$ are the proportions of each instar in the sample, $\mu_k$ are their mean sizes and $\sigma_k^2$ are their variances.

However, inference for larger instars is generally more uncertain owing to increasing variability in growth during adolescence, which resulting in size overlap between successive instars at these stages.

### Model Assumptions

- Skip-moulters moult to maturity the following year.
- Skip-moulters only exist from instar IX and onward.
- Females have negligible amounts of skip-moulting.
- Matures exist only from instar IX onward.
- 

### Population dynamics equations

Stage-based processes affecting the population dynamics are the probability of moulting to maturity from one instar to the next, the probability of an instar skipping a moult (i.e. not growing and remaining mature) and annual mortality for immatures and matures.

The selectivity function is length-based, being a sigmoid-type function.

With $y$ indxing the survey year and $k$ indexing the instar, the population dynamics equations are as follows:

$$
\begin{aligned}
   n_{k,y}^{imm}  &= (1-p_{k-1,y-1}^{mat}) \times (1-p_{k-1}^{skip}) \times (1-M^{imm}) \times n_{k-1,y-1}^{imm} \\
   n_{k,y}^{skip} &= (1-p_{k-1,y-1}^{mat}) \times p_{k-1}^{skp} \times (1-M^{imm}) \times n_{k,y-1}^{imm} \\
   n_{k,y}^{rec}  &= (1-M^{mat}) \times \left[(1-p_{k-1}^{skp}) \times p_{k-1,y-1}^{mat} \times n_{k-1,y-1}^{imm} + n_{k-1,y-1}^{skip} \right] \\  
   n_{k,y}^{res}  &= (1-M^{mat}) \times \left[n_{k,y-1}^{rec} + n_{k,y-1}^{res} \right] \\ 
   n_{k,y}^{mat}  &= n_{k,y}^{rec} + n_{k,y}^{res}
\end{aligned}
$$
with the superscripts $imm$ representing regular immatures, $skip$ representing immatures which have skipped the previous moult, $rec$ representing new mature recruits, $res$ representing residuals matures and $mat$ representing all matures, i.e. the sum of recruits and residuals. 


|     Variable      | Description                                                         |
|:-----------------:|:--------------------------------------------------------------------|
| $n_{k,y}^{imm}$   | Population number of immature crab.
| $n_{k,y}^{skip}$  | Population number of immature crab which skipped the previous moult.
| $n_{k,y}^{rec}$   | Population number of new mature recruits.
| $n_{k,y}^{res}$   | Population number of old mature residuals (i.e. non-recruits).
| $n_{k,y}^{mat}$   | Population number of total mature crab.
| $M^{imm}$         | Annual proportion of immature crab which die off.
| $M^{mat}$         | Annual proportion of mature crab which die off.
| $p_{k,y}^{skip}$  | Annual proportion of immature crab which skip a moult. 
| $p_{k,y}^{mat}$   | Annual proportion of immature crab which moult to maturity. 

\newpage

## Figures

![Fitted population model abundances for immature (red) and mature (blue) female snow crab. Jagged curves are observed length-frequencies.](female model and length-frequencies 2010-2020.pdf) 

![Fitted selectivity curve for female snow crab](female trawl selectivity.png) 

![Annual probability of immature instar VIII moulting to mature IX for female snow crab](female moultring probability VIII to IX.png) 


## To do: 
- Remove superfluous p_mat and p_skip row/column
- Add interaction error / mortality variability
- Add vessel effect
- Add mature growth modification   
- Display histograms with immatures y and mature y + 1 
- Add annual global scaling effect.
- Improve instar variance fit for matures.
- Improve growth mean fit for immature instars VIII and IX.
- Implement log_mu_year which better controls variability within instars
- Model seems to be growing adolescents too fast, but log_mu_year shrinks them back down ... an effort to....?
      
